generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  runtime         = "nodejs"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
}

enum AccountStatus {
  ACTIVE
  PASSIVE
  BANNED
  PENDING_APPROVAL // B2B kayıtları için onay süreci
}

enum RegistrationSource {
  WEB_REGISTER
  ADMIN_PANEL
  IMPORT_EXCEL // CSV/Excel yüklemeleri için
  API
  CHECKOUT_GUEST
  PROVIDER_OAUTH
}

enum SubscriptionStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  PENDING
}

enum StoreType {
  B2C // Son kullanıcıya satış
  B2B // Bayilere satış
}

enum RoutingStrategy {
  PATH_PREFIX // site.com/tr, b2b.site.com/en (En güvenlisi, Standart)
  SUBDOMAIN // tr.site.com, en.site.com (Sadece B2C için)
  COOKIE_ONLY // site.com (URL değişmez, dil cookie'den okunur)
}

model Organization {
  id     String  @id @default(cuid())
  name   String
  stores Store[]
}

model Store {
  id   String @id @default(cuid())
  name String

  subdomain String    @unique
  type      StoreType // B2C veya B2B
  isActive  Boolean   @default(true)

  users    User[]
  orders   OrderSchema[]
  products Product[]

  settings      StoreSettings?
  localeConfigs StoreLocaleConfig[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Bir firmada her type'tan sadece 1 store olabilir
  @@unique([type])
}

model StoreSettings {
  id      String @id @default(cuid())
  storeId String @unique
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // B2C için
  customDomain String?         @unique
  routing      RoutingStrategy @default(PATH_PREFIX)

  // Genel
  defaultLocale Locale @default(TR)
}

model StoreLocaleConfig {
  id      String @id @default(cuid())
  storeId String

  // Kuralın Girdisi: DİL
  locale Locale // Örn: EN

  // Kuralın Çıktısı: PARA BİRİMİ
  currency Currency // Örn: USD

  // Opsiyonel: Bu dil aktif mi? (Örn: Almanca'yı ekledin ama yayına almadın)
  isActive Boolean @default(true)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Bir mağazada, bir dil için sadece bir tane config olabilir.
  // Yani EN hem USD hem GBP olamaz.
  @@unique([storeId, locale])
}

model User {
  id   String   @id @default(cuid())
  role UserRole @default(USER)

  // Kimlik Bilgileri
  name     String
  surname  String
  email    String? @unique
  phone    String? @unique
  password String?
  imageUrl String?

  // Durum & Güvenlik
  accountStatus   AccountStatus @default(ACTIVE)
  isEmailVerified Boolean       @default(false)
  emailVerifiedAt DateTime?
  isPhoneVerified Boolean       @default(false)
  phoneVerifiedAt DateTime?

  // Pazarlama & Kaynak
  registrationSource RegistrationSource @default(WEB_REGISTER)
  subscriptionStatus SubscriptionStatus @default(UNSUBSCRIBED)
  note               String? // Admin notu
  tags               CustomerTag[] // Hızlı etiketleme (Örn: "Sorunlu Müşteri")

  // İstatistikler (Segmentasyon için kritik - Cron ile veya event ile güncellenir)
  orderCount     Int       @default(0)
  totalSpent     Decimal   @default(0) // Float yerine Decimal kullan, para bu
  lastOrderDate  DateTime?
  firstOrderDate DateTime?

  // B2B & Gruplama
  customerGroups CustomerGroup[] // Statik gruplar (Many-to-Many)
  priceListId    String? // Kullanıcıya özel fiyat listesi varsa
  priceList      PriceList?      @relation(fields: [priceListId], references: [id])

  // Custom Attributes (Ikas'taki attributes gibi esnek alanlar)
  // Örn: { "vergiDairesi": "Besiktas", "sektor": "Tekstil" }
  customAttributes Json?

  // Mevcut İlişkiler
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  defaultAddressId String?         @unique
  addresses        AddressSchema[]
  carts            Cart[]
  orders           OrderSchema[]
  defaultAddress   AddressSchema?  @relation("UserDefaultAddress", fields: [defaultAddressId], references: [id])

  // İndirim ilişkileri (Mevcut yapın)
  specificDiscounts DiscountCustomer[]
  discountUsages    DiscountUsage[]
  refreshTokens     RefreshTokens[]
  storeId           String?
  store             Store?             @relation(fields: [storeId], references: [id])

  @@index([email, phone])
  @@index([accountStatus])
  @@index([totalSpent]) // Segmentasyon sorguları için
  @@index([orderCount])
}

model CustomerTag {
  id    String @id @default(cuid())
  name  String @unique // Örn: "influencer", "iadeci", "toptanci"
  users User[]
}

// 2. Statik Müşteri Grupları (Manuel Atama)
enum GroupType {
  MANUAL // Eski usül: Admin elle ekler veya "Register Flow" sonucu buraya ID yazılır.
  SMART // (Dinamik): İçindeki 'conditions' JSON'ına uyanları anlık getirir.
}

model CustomerGroup {
  id          String  @id @default(cuid())
  name        String // Örn: "VIP Müşteriler" veya "Manuel Onaylılar"
  description String?

  type GroupType @default(MANUAL)

  // --- SMART GROUP İÇİN ---
  // Senin Karar Ağacı UI'ından çıkan JSON buraya kaydedilecek.
  // Örn: { "logic": "AND", "rules": [{ "field": "totalSpent", "op": "gt", "value": 5000 }] }
  conditions Json?

  // --- MANUAL GROUP İÇİN ---
  // Statik olarak veritabanında ilişki kurulmuş üyeler
  users User[]

  // ORTAK ÖZELLİKLER
  isDefault  Boolean     @default(false)
  priceLists PriceList[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PriceListType {
  OVERRIDE // Ana fiyatı ezer (Kesin Fiyat)
  DISCOUNT // Ana fiyat üzerinden % indirim yapar
  INCREASE // Ana fiyat üzerine ekleme yapar
}

model PriceList {
  id       String        @id @default(cuid())
  name     String // Örn: "2025 Toptan Fiyat Listesi"
  currency Currency      @default(TRY)
  type     PriceListType @default(OVERRIDE)

  // Genel bir oran varsa (Örn: Tüm ürünlere %20 indirim)
  adjustmentValue Float?

  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Kimler bu fiyatı görür?
  users  User[] // Direkt atanan kullanıcılar
  groups CustomerGroup[] // Atanan gruplar

  // Ürün bazlı özel fiyatlar
  prices ProductPriceListPrice[]
}

// Bir ürünün, spesifik bir listedeki fiyatı
model ProductPriceListPrice {
  id          String @id @default(cuid())
  priceListId String
  variantId   String // Varyant bazlı fiyatlandırma

  price       Float // Listeye özel fiyat
  minQuantity Int   @default(1) // Kademeli fiyat (Tiered Pricing) için

  priceList PriceList                 @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  variant   ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([priceListId, variantId, minQuantity])
  @@index([variantId])
}

model RefreshTokens {
  id                 String         @id @default(cuid())
  hashedRefreshToken String         @unique
  userAgent          String?
  os                 String?
  browser            String?
  deviceType         String?
  ipAddress          String?
  userId             String
  expiresAt          DateTime
  revokedAt          DateTime?
  createdAt          DateTime       @default(now())
  replacedByTokenId  String?        @unique
  replacedBy         RefreshTokens? @relation("TokenChain", fields: [replacedByTokenId], references: [id])
  predecessor        RefreshTokens? @relation("TokenChain")
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Asset {
  id                String             @id @default(cuid())
  type              AssetType          @default(IMAGE)
  url               String             @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  brand             Brand?
  category          Category?
  productAsset      ProductAsset[]
  desktopSliderItem SliderItemSchema[] @relation("DesktopAsset")
  mobileSliderItem  SliderItemSchema[] @relation("MobileAsset")
  variantOption     VariantOption?

  @@index([url])
}

model CategoryTranslation {
  id              String   @id @default(cuid())
  locale          Locale   @default(TR)
  name            String
  slug            String
  description     String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([locale, categoryId])
  @@unique([locale, slug])
}

model Category {
  id                      String                 @id @default(cuid())
  imageId                 String?                @unique
  parentCategoryId        String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  categoryGridComponentId String?
  categoryGridComponent   CategoryGridComponent? @relation(fields: [categoryGridComponentId], references: [id], onDelete: Cascade)
  image                   Asset?                 @relation(fields: [imageId], references: [id], onDelete: Cascade)
  parentCategory          Category?              @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id], onDelete: SetNull)
  childCategories         Category[]             @relation("CategoryHierarchy")
  translations            CategoryTranslation[]
  discountConditions      DiscountCategory[]
  footerLinks             FooterLinks[]
  products                ProductCategory[]

  @@index([parentCategoryId])
}

model TaxonomyCategory {
  id           String             @id @default(cuid())
  googleId     String             @unique
  parentId     String?
  path         String?
  pathNames    String?
  depth        Int                @default(0)
  originalName String
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  products     Product[]
  parent       TaxonomyCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     TaxonomyCategory[] @relation("CategoryHierarchy")

  @@index([googleId])
  @@index([parentId])
  @@index([path])
  @@index([depth])
  @@index([isActive])
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

model BrandTranslation {
  id              String   @id @default(cuid())
  locale          Locale   @default(TR)
  name            String
  slug            String
  description     String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([locale, brandId])
  @@unique([locale, slug])
}

model Brand {
  id                 String             @id @default(cuid())
  imageId            String?            @unique
  parentBrandId      String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  deletedAt          DateTime?
  image              Asset?             @relation(fields: [imageId], references: [id])
  parentBrand        Brand?             @relation("BrandHierarchy", fields: [parentBrandId], references: [id], onDelete: SetNull)
  childBrands        Brand[]            @relation("BrandHierarchy")
  translations       BrandTranslation[]
  discountConditions DiscountBrand[]
  footerLinks        FooterLinks[]
  products           Product[]

  @@index([parentBrandId])
}

model VariantGroupTranslation {
  id             String       @id @default(cuid())
  locale         Locale       @default(TR)
  name           String
  slug           String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  variantGroupId String
  VariantGroup   VariantGroup @relation(fields: [variantGroupId], references: [id], onDelete: Cascade)

  @@unique([locale, variantGroupId])
  @@unique([locale, slug])
  @@index([locale, slug])
  @@index([variantGroupId])
}

model VariantGroup {
  id                   String                    @id @default(cuid())
  type                 VariantGroupType          @default(LIST)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  productVariantGroups ProductVariantGroup[]
  translations         VariantGroupTranslation[]
  options              VariantOption[]

  @@index([type])
}

model VariantOptionTranslation {
  id              String        @id @default(cuid())
  locale          Locale        @default(TR)
  name            String
  slug            String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  variantOptionId String
  variantOption   VariantOption @relation(fields: [variantOptionId], references: [id], onDelete: Cascade)

  @@unique([variantOptionId, locale])
  @@unique([locale, slug])
  @@index([locale, slug])
  @@index([variantOptionId])
}

model VariantOption {
  id                    String                     @id @default(cuid())
  hexValue              String?
  assetId               String?                    @unique
  variantGroupId        String
  createdAt             DateTime                   @default(now())
  updatedAt             DateTime                   @updatedAt
  productVariantOptions ProductVariantOption[]     @relation("ProductVariantOptions")
  asset                 Asset?                     @relation(fields: [assetId], references: [id])
  variantGroup          VariantGroup               @relation(fields: [variantGroupId], references: [id], onDelete: Cascade)
  translations          VariantOptionTranslation[]

  @@index([variantGroupId])
  @@index([hexValue])
}

model ProductTranslation {
  id              String   @id @default(cuid())
  locale          Locale   @default(TR)
  name            String
  slug            String
  description     String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  productId       String?
  Product         Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([locale, productId])
  @@unique([locale, slug])
  @@index([locale, slug, productId])
}

model ProductPrice {
  id              String   @id @default(cuid())
  currency        Currency @default(TRY)
  price           Float
  buyedPrice      Float?
  discountedPrice Float?
  variantId       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  variant ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, currency])
  @@index([variantId, currency])
}

model ProductAsset {
  id        String   @id @default(cuid())
  order     Int
  assetId   String
  productId String?
  variantId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset   Asset                      @relation(fields: [assetId], references: [id], onDelete: Cascade)
  product Product?                   @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariantCombination? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId, order])
  @@index([variantId, order])
}

model ProductTagTranslation {
  id           String     @id @default(cuid())
  locale       Locale     @default(TR)
  name         String
  slug         String
  productTagId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  productTag   ProductTag @relation(fields: [productTagId], references: [id], onDelete: Cascade)

  @@unique([locale, productTagId])
  @@unique([locale, slug])
}

model ProductTag {
  id           String                  @id @default(cuid())
  color        String?
  icon         String?
  priority     Int?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  products     ProductTagOnProduct[]
  translations ProductTagTranslation[]
}

model ProductTagOnProduct {
  productId    String
  productTagId String
  assignedAt   DateTime   @default(now())
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  productTag   ProductTag @relation(fields: [productTagId], references: [id], onDelete: Cascade)

  @@id([productId, productTagId])
  @@index([productId])
  @@index([productTagId])
}

model Product {
  id                     String      @id @default(cuid())
  type                   ProductType @default(PHYSICAL)
  active                 Boolean     @default(true)
  brandId                String?
  taxonomyCategoryId     String?
  visibleAllCombinations Boolean     @default(false)
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt
  deletedAt              DateTime?
  deletedBy              String?
  deleteReason           String?

  brand            Brand?                      @relation(fields: [brandId], references: [id], onDelete: SetNull)
  taxonomyCategory TaxonomyCategory?           @relation(fields: [taxonomyCategoryId], references: [id], onDelete: SetNull)
  categories       ProductCategory[]
  tags             ProductTagOnProduct[]
  translations     ProductTranslation[]
  variantGroups    ProductVariantGroup[]
  variants         ProductVariantCombination[]
  assets           ProductAsset[]
  offerInCampaigns CampaignOffer[]

  buyableInCampaigns   CampaignBuyableProduct[]
  conditionInCampaigns CampaignConditionProduct[]
  discountConditions   DiscountProduct[]
  footerLinks          FooterLinks[]
  store                Store[]

  @@index([brandId])
  @@index([taxonomyCategoryId])
  @@index([active])
  @@index([deletedAt])
  @@index([active, deletedAt])
}

model ProductVariantGroup {
  id                String                 @id @default(cuid())
  productId         String
  variantGroupId    String
  order             Int
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  renderVisibleType VariantGroupRenderType @default(DROPDOWN)
  product           Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantGroup      VariantGroup           @relation(fields: [variantGroupId], references: [id], onDelete: Cascade)
  options           ProductVariantOption[]

  @@unique([productId, variantGroupId])
  @@index([productId])
  @@index([variantGroupId])
  @@index([productId, order])
}

model ProductVariantOption {
  id                    String                            @id @default(cuid())
  productVariantGroupId String
  variantOptionId       String
  order                 Int
  createdAt             DateTime                          @default(now())
  updatedAt             DateTime                          @updatedAt
  combinations          ProductVariantCombinationOption[]
  productVariantGroup   ProductVariantGroup               @relation(fields: [productVariantGroupId], references: [id], onDelete: Cascade)
  variantOption         VariantOption                     @relation("ProductVariantOptions", fields: [variantOptionId], references: [id], onDelete: Cascade)

  @@unique([productVariantGroupId, variantOptionId])
  @@index([productVariantGroupId])
  @@index([variantOptionId])
  @@index([productVariantGroupId, order])
}

model ProductVariantCombination {
  id        String    @id @default(cuid())
  productId String
  sku       String?   @unique
  barcode   String?   @unique
  stock     Int       @default(0)
  active    Boolean   @default(true)
  isDefault Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  product         Product                           @relation(fields: [productId], references: [id], onDelete: Cascade)
  options         ProductVariantCombinationOption[]
  translations    ProductVariantTranslation[]
  priceListPrices ProductPriceListPrice[]

  prices           ProductPrice[]
  assets           ProductAsset[]
  cartItems        CartItem[]
  orderItems       OrderItemSchema[]
  productListItems ProductListCarouselItem[]

  buyableInCampaigns   CampaignBuyableVariant[]
  conditionInCampaigns CampaignConditionVariant[]
  offerInCampaigns     CampaignOffer[]
  discountConditions   DiscountProductVariant[]

  inventoryItem      InventoryItem?
  transferItems      InventoryTransferItem[]
  adjustmentItems    InventoryAdjustmentItem[]
  supplierProducts   SupplierProduct[]
  supplierOrderItems SupplierOrderItem[]

  @@index([productId])
  @@index([active])
  @@index([sku])
  @@index([barcode])
  @@index([productId, isDefault])
  @@index([deletedAt])
  @@index([productId, active, deletedAt])
}

model ProductVariantCombinationOption {
  id                     String                    @id @default(cuid())
  combinationId          String
  productVariantOptionId String
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt
  combination            ProductVariantCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  productVariantOption   ProductVariantOption      @relation(fields: [productVariantOptionId], references: [id], onDelete: Cascade)

  @@unique([combinationId, productVariantOptionId])
  @@index([combinationId])
  @@index([productVariantOptionId])
}

model ProductVariantTranslation {
  id              String                    @id @default(cuid())
  combinationId   String
  locale          Locale                    @default(TR)
  description     String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  combination     ProductVariantCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)

  @@unique([combinationId, locale])
  @@index([combinationId, locale])
}

model CountryTranslation {
  id        String   @id @default(cuid())
  locale    Locale   @default(TR)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  countryId String
  Country   Country  @relation(fields: [countryId], references: [id])

  @@unique([locale, countryId])
  @@index([countryId])
  @@index([locale])
  @@index([name])
}

model Country {
  id                 String                  @id
  name               String
  iso2               String?
  iso3               String?
  phoneCode          String?
  capital            String?
  currency           String?
  native             String?
  region             String?
  subregion          String?
  emoji              String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  type               CountryType             @default(STATE)
  addressSchema      AddressSchema[]
  cities             City[]
  countryCurrencyMap CountryDefaultSettings?
  translations       CountryTranslation[]
  cargoLocation      Location[]
  states             State[]

  inventoryLocations    InventoryLocation[]
  inventoryServiceZones InventoryLocationServiceZone[]

  @@index([name])
  @@index([iso2])
  @@index([iso3])
  @@index([region])
  @@index([subregion])
  @@index([currency])
}

model State {
  id                 String              @id
  name               String
  stateCode          String?
  countryId          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  addressSchema      AddressSchema[]
  Country            Country             @relation(fields: [countryId], references: [id])
  inventoryLocations InventoryLocation[]

  @@index([countryId])
  @@index([name])
  @@index([stateCode])
  @@index([countryId, name])
}

model City {
  id                 String              @id
  name               String
  latitude           String?
  longitude          String?
  countryId          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  addressSchema      AddressSchema[]
  country            Country             @relation(fields: [countryId], references: [id])
  districts          District[]
  inventoryLocations InventoryLocation[]

  @@index([countryId])
  @@index([name])
  @@index([latitude, longitude])
}

model District {
  id                 String              @id
  name               String
  cityId             String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  addressSchema      AddressSchema[]
  city               City                @relation(fields: [cityId], references: [id])
  inventoryLocations InventoryLocation[]

  @@index([cityId])
}

model CartItem {
  id           String          @id @default(cuid())
  quantity     Int             @default(1)
  whereAdded   WhereAdded      @default(PRODUCT_PAGE)
  isVisible    Boolean         @default(true)
  visibleCause inVisibleCause?
  variantId    String
  cartId       String
  deletedAt    DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  logs    CartActivityLog[]
  cart    Cart                      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, variantId])
  @@index([cartId, variantId])
}

model CartActivityLog {
  id           String           @id @default(cuid())
  cartId       String
  cartItemId   String?
  activityType CartActivityType
  actorType    ActorType        @default(USER)
  actorId      String?
  details      Json?
  createdAt    DateTime         @default(now())
  cart         Cart             @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartItem     CartItem?        @relation(fields: [cartItemId], references: [id])

  @@index([cartId, createdAt(sort: Desc)])
  @@index([cartItemId])
}

model Cart {
  id                       String                     @id @default(cuid())
  status                   CartStatus                 @default(ACTIVE)
  currency                 Currency                   @default(TRY)
  locale                   Locale                     @default(TR)
  shippingAddressId        String?
  billingAddressId         String?
  cargoRuleId              String?
  userId                   String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  billingAddress           AddressSchema?             @relation("CartBillingAddress", fields: [billingAddressId], references: [id])
  cargoRule                CargoRule?                 @relation(fields: [cargoRuleId], references: [id])
  shippingAddress          AddressSchema?             @relation("CartShippingAddress", fields: [shippingAddressId], references: [id])
  user                     User?                      @relation(fields: [userId], references: [id])
  cartActivityLogs         CartActivityLog[]
  items                    CartItem[]
  cartPaymentCheckAttempts CartPaymentCheckAttempts[]
  orderAttempts            OrderSchema[]
}

model CartPaymentCheckAttempts {
  id        String   @id @default(cuid())
  cartId    String
  message   String?
  isSuccess Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
}

model FooterLinks {
  id                String           @id @default(cuid())
  order             Int
  title             String
  options           Json?
  customLink        String?
  productId         String?
  categoryId        String?
  brandId           String?
  footerLinkGroupId String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  brand             Brand?           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category          Category?        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  footerLinkGroup   FooterLinkGroups @relation(fields: [footerLinkGroupId], references: [id], onDelete: Cascade)
  product           Product?         @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model FooterLinkGroups {
  id        String        @id @default(cuid())
  order     Int
  title     String
  options   Json?
  footerId  String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  footer    Footer        @relation(fields: [footerId], references: [id], onDelete: Cascade)
  links     FooterLinks[]
}

model Footer {
  id         String             @id @default(cuid())
  options    Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  linkGroups FooterLinkGroups[]
}

model SliderItemSchema {
  id               String         @id @default(cuid())
  order            Int
  isActive         Boolean        @default(true)
  mobileAssetId    String?
  desktopAssetId   String?
  customLink       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  sliderSettingsId String
  desktopAsset     Asset?         @relation("DesktopAsset", fields: [desktopAssetId], references: [id])
  mobileAsset      Asset?         @relation("MobileAsset", fields: [mobileAssetId], references: [id])
  SliderSettings   SliderSettings @relation(fields: [sliderSettingsId], references: [id])

  @@index([isActive])
}

model SliderSettings {
  id               String             @id @default(cuid())
  isAutoPlay       Boolean            @default(false)
  autoPlayInterval Int?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  component        LayoutComponent[]
  items            SliderItemSchema[]
}

model MarqueeSchema {
  id         String            @id @default(cuid())
  options    Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  components LayoutComponent[]
}

model ProductListCarouselTranslation {
  id                    String              @id @default(cuid())
  locale                Locale              @default(TR)
  title                 String
  productListCarouselId String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  productListCarousel   ProductListCarousel @relation(fields: [productListCarouselId], references: [id], onDelete: Cascade)

  @@unique([locale, productListCarouselId])
  @@index([productListCarouselId])
}

model ProductListCarousel {
  id           String                           @id @default(cuid())
  createdAt    DateTime                         @default(now())
  updatedAt    DateTime                         @updatedAt
  components   LayoutComponent[]
  items        ProductListCarouselItem[]
  translations ProductListCarouselTranslation[]
}

model ProductListCarouselItem {
  id                    String   @id @default(cuid())
  productListCarouselId String
  variantId             String
  order                 Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  variant             ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)
  productListCarousel ProductListCarousel       @relation(fields: [productListCarouselId], references: [id], onDelete: Cascade)

  @@unique([productListCarouselId, variantId])
  @@unique([productListCarouselId, order])
  @@index([productListCarouselId, order])
}

model CategoryGridComponent {
  id         String            @id @default(cuid())
  options    Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  categories Category[]
  components LayoutComponent[]
}

model LayoutComponent {
  id                      String                 @id @default(cuid())
  type                    LayoutComponentType
  order                   Int
  layoutId                String
  sliderId                String?
  marqueeId               String?
  productListCarouselId   String?
  categoryGridComponentId String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  categoryGrid            CategoryGridComponent? @relation(fields: [categoryGridComponentId], references: [id], onDelete: Cascade)
  layout                  Layout                 @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  marquee                 MarqueeSchema?         @relation(fields: [marqueeId], references: [id], onDelete: Cascade)
  productListCarousel     ProductListCarousel?   @relation(fields: [productListCarouselId], references: [id], onDelete: Cascade)
  slider                  SliderSettings?        @relation(fields: [sliderId], references: [id])

  @@unique([layoutId, order])
}

model Layout {
  id            String            @id @default(cuid())
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  otherSettings Json?
  components    LayoutComponent[]
}

model AddressSchema {
  id                         String        @id @default(cuid())
  email                      String?
  addressTitle               String?
  phone                      String
  tcKimlikNo                 String?
  name                       String
  surname                    String
  addressLine1               String
  addressLine2               String?
  zipCode                    String?
  countryId                  String
  stateId                    String?
  cityId                     String?
  userId                     String?
  addressLocationType        CountryType
  isBillingAddress           Boolean       @default(false)
  isCorporateInvoice         Boolean       @default(false)
  companyName                String?
  taxNumber                  String?
  companyRegistrationAddress String?
  districtId                 String?
  createdAt                  DateTime      @default(now())
  updatedAt                  DateTime      @updatedAt
  city                       City?         @relation(fields: [cityId], references: [id])
  country                    Country       @relation(fields: [countryId], references: [id])
  district                   District?     @relation(fields: [districtId], references: [id])
  state                      State?        @relation(fields: [stateId], references: [id])
  user                       User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingCarts               Cart[]        @relation("CartBillingAddress")
  shippingCarts              Cart[]        @relation("CartShippingAddress")
  billingOrders              OrderSchema[] @relation("OrderSchemaBillingAddress")
  shippingOrders             OrderSchema[] @relation("OrderSchemaShippingAddress")
  defaultForUser             User?         @relation("UserDefaultAddress")

  @@index([userId])
  @@index([countryId])
  @@index([stateId])
  @@index([cityId])
}

model CountryDefaultSettings {
  id           String   @id @default(cuid())
  countryId    String   @unique
  currency     Currency @default(TRY)
  locale       Locale   @default(TR)
  translations Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  country      Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
}

model CargoZone {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  rules     CargoRule[]
  locations Location[]
}

model Location {
  id          String    @id @default(cuid())
  cargoZoneId String
  countryId   String
  stateIds    String[]  @default([])
  cityIds     String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cargoZone   CargoZone @relation(fields: [cargoZoneId], references: [id], onDelete: Cascade)
  country     Country   @relation(fields: [countryId], references: [id])

  @@unique([cargoZoneId, countryId])
}

model CargoRule {
  id          String        @id @default(cuid())
  name        String
  ruleType    RuleType      @default(SalesPrice)
  minValue    Float?
  maxValue    Float?
  price       Float?
  currency    Currency      @default(TRY)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  cargoZoneId String?
  CargoZone   CargoZone?    @relation(fields: [cargoZoneId], references: [id])
  carts       Cart[]
  orders      OrderSchema[]

  @@index([ruleType])
}

model Discount {
  id                           String                    @id @default(cuid())
  title                        String
  type                         DiscountType
  currencies                   Currency[]
  startDate                    DateTime?
  endDate                      DateTime?
  isLimitPurchase              Boolean                   @default(false)
  minPurchaseAmount            Float?
  maxPurchaseAmount            Float?
  isLimitItemQuantity          Boolean                   @default(false)
  minItemQuantity              Int?
  maxItemQuantity              Int?
  allowDiscountedItems         Boolean                   @default(false)
  allowedDiscountedItemsBy     AllowedDiscountedItemsBy?
  mergeOtherCampaigns          Boolean                   @default(false)
  isLimitTotalUsage            Boolean                   @default(false)
  totalUsageLimit              Int?
  isLimitTotalUsagePerCustomer Boolean                   @default(false)
  totalUsageLimitPerCustomer   Int?
  discountValue                Float?
  discountAmount               Float?
  isAllCustomers               Boolean                   @default(true)
  isAllProducts                Boolean                   @default(true)
  createdAt                    DateTime                  @default(now())
  updatedAt                    DateTime                  @updatedAt
  status                       CampaignStatus            @default(DRAFT)
  coupons                      Coupon[]
  conditionGroups              DiscountConditionGroup[]
  customers                    DiscountCustomer[]
  tiers                        DiscountTier[]
  usages                       DiscountUsage[]

  @@index([startDate, endDate])
}

model Coupon {
  id         String          @id @default(cuid())
  code       String          @unique
  discountId String
  usageCount Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  isDelete   Boolean         @default(false)
  discount   Discount        @relation(fields: [discountId], references: [id], onDelete: Cascade)
  usages     DiscountUsage[]

  @@index([code])
  @@index([discountId])
}

model DiscountTier {
  id                 String   @id @default(cuid())
  discountId         String
  minQuantity        Int?
  maxQuantity        Int?
  minAmount          Float?
  maxAmount          Float?
  discountPercentage Float?
  discountAmount     Float?
  discount           Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@index([discountId])
}

model DiscountCustomer {
  discountId String
  userId     String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([discountId, userId])
}

model DiscountConditionGroup {
  id         String                   @id @default(cuid())
  discountId String
  operator   LogicalOperator          @default(AND)
  type       DiscountConditionType    @default(PRODUCT)
  brands     DiscountBrand[]
  categories DiscountCategory[]
  discount   Discount                 @relation(fields: [discountId], references: [id], onDelete: Cascade)
  products   DiscountProduct[]
  variants   DiscountProductVariant[]

  @@index([discountId])
}

model DiscountProduct {
  groupId   String
  productId String
  group     DiscountConditionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  product   Product                @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([groupId, productId])
}

model DiscountCategory {
  groupId    String
  categoryId String
  category   Category               @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  group      DiscountConditionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([groupId, categoryId])
}

model DiscountBrand {
  groupId String
  brandId String
  brand   Brand                  @relation(fields: [brandId], references: [id], onDelete: Cascade)
  group   DiscountConditionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([groupId, brandId])
}

model DiscountProductVariant {
  groupId   String
  variantId String
  group     DiscountConditionGroup    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  variant   ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@id([groupId, variantId])
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String
  couponId   String
  userId     String
  orderId    String   @unique
  amount     Float
  usedAt     DateTime @default(now())
  coupon     Coupon   @relation(fields: [couponId], references: [id])
  discount   Discount @relation(fields: [discountId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([discountId])
  @@index([couponId])
  @@index([userId])
}

model Campaign {
  id                      String                     @id @default(cuid())
  title                   String
  campaignType            CampaignType
  validCurrencies         Currency[]
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt
  dates                   Json
  requirements            Json
  conditionsIsAllProducts Boolean?
  campaignOfferType       CampaignOfferTargetPage?
  status                  CampaignStatus             @default(DRAFT)
  buyableProducts         CampaignBuyableProduct[]
  buyableVariants         CampaignBuyableVariant[]
  conditionProducts       CampaignConditionProduct[]
  conditionVariants       CampaignConditionVariant[]
  offers                  CampaignOffer[]
}

model CampaignBuyableProduct {
  campaignId String
  productId  String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([campaignId, productId])
}

model CampaignBuyableVariant {
  campaignId String
  variantId  String
  campaign   Campaign                  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  variant    ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@id([campaignId, variantId])
}

model CampaignConditionProduct {
  campaignId String
  productId  String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([campaignId, productId])
}

model CampaignConditionVariant {
  campaignId String
  variantId  String
  campaign   Campaign                  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  variant    ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@id([campaignId, variantId])
}

model CampaignOffer {
  id                          String                   @id @default(cuid())
  order                       Int
  title                       String
  description                 String
  variantId                   String?
  applyToAllVariants          Boolean                  @default(false)
  productId                   String?
  discountType                DiscountType
  discountValue               Float
  discountValueAppliedByPrice AllowedDiscountedItemsBy
  addCountDown                Boolean
  countDownMinute             Int?
  showProductIfInCart         Boolean                  @default(false)
  campaignId                  String

  campaign Campaign                   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  product  Product?                   @relation(fields: [productId], references: [id])
  variant  ProductVariantCombination? @relation(fields: [variantId], references: [id])

  @@index([campaignId])
  @@index([productId])
  @@index([variantId])
}

model StorePaymentProvider {
  id         String          @id @default(cuid())
  active     Boolean         @default(true)
  options    Json?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  isTestMode Boolean         @default(true)
  provider   PaymentProvider @unique
}

model AssetLibrary {
  id        String    @id @default(cuid())
  assetType AssetType @default(IMAGE)
  url       String
  altText   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model OrderItemSchema {
  id              String          @id @default(cuid())
  buyedPrice      Decimal
  quantity        Int             @default(1)
  totalPrice      Decimal
  totalFinalPrice Decimal
  discountAmount  Decimal?
  taxAmount       Decimal?
  variantSnapshot Json
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  status          OrderItemStatus @default(PENDING)
  variantId       String
  orderId         String
  shipmentId      String?

  order    OrderSchema               @relation(fields: [orderId], references: [id])
  shipment Shipment?                 @relation(fields: [shipmentId], references: [id])
  variant  ProductVariantCombination @relation(fields: [variantId], references: [id])

  @@unique([orderId, variantId])
}

model OrderSchema {
  id                      String          @id @default(cuid())
  orderNumber             String          @unique
  totalPrice              Decimal
  totalFinalPrice         Decimal
  discountAmount          Decimal?
  taxAmount               Decimal?
  shippingCost            Decimal?
  currency                Currency        @default(TRY)
  locale                  Locale          @default(TR)
  orderNote               String?
  paymentProvider         PaymentProvider @default(IYZICO)
  paymentStatus           PaymentStatus   @default(PENDING)
  orderStatus             OrderStatus     @default(PENDING)
  shippingAddressSnapshot Json?
  billingAddressSnapshot  Json?
  cargoRuleSnapshot       Json?
  clientIp                String?
  userAgent               String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  cartId                  String?
  userId                  String?
  shippingAddressRecordId String?
  billingAddressRecordId  String?
  cargoRuleId             String?

  // === YENİ EKLENEN KISIM ===
  storeId String? // Siparişin ait olduğu mağaza ID'si
  store   Store?  @relation(fields: [storeId], references: [id])
  // ==========================

  itemsSchema           OrderItemSchema[]
  billingAddressRecord  AddressSchema?           @relation("OrderSchemaBillingAddress", fields: [billingAddressRecordId], references: [id])
  cargoRule             CargoRule?               @relation(fields: [cargoRuleId], references: [id])
  cart                  Cart?                    @relation(fields: [cartId], references: [id])
  shippingAddressRecord AddressSchema?           @relation("OrderSchemaShippingAddress", fields: [shippingAddressRecordId], references: [id])
  user                  User?                    @relation(fields: [userId], references: [id])
  transactions          OrderTransactionSchema[]
  shipments             Shipment[]

  @@index([storeId]) // Performans için index eklemek iyi olur
}

model OrderTransactionSchema {
  id                    String           @id @default(cuid())
  orderId               String
  providerTransactionId String?
  amount                Decimal
  status                PaymentStatus
  paymentType           PaymentType
  provider              PaymentProvider
  binNumber             String?
  lastFourDigits        String?
  cardAssociation       CardAssociation?
  cardFamilyName        String?
  gatewayResponse       Json?
  createdAt             DateTime         @default(now())
  order                 OrderSchema      @relation(fields: [orderId], references: [id])
}

model Shipment {
  id               String            @id @default(cuid())
  orderId          String
  trackingCode     String?
  shippingProvider String?
  status           ShipmentStatus    @default(PENDING)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  orderItems       OrderItemSchema[]
  order            OrderSchema       @relation(fields: [orderId], references: [id])
}

model ErrorLog {
  id        String   @id @default(cuid())
  message   String
  stack     String?
  errorCode String?
  context   String
  meta      Json?
  createdAt DateTime @default(now())

  @@index([context])
  @@index([createdAt(sort: Desc)])
}

model Theme {
  id             String         @id @default(cuid())
  name           String
  isActive       Boolean        @default(false)
  globalSettings Json           @default("{}")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  pageTemplates  PageTemplate[]
}

model PageTemplate {
  id        String   @id @default(cuid())
  name      String
  pageType  PageType
  themeId   String
  sections  Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme     Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@unique([themeId, pageType, name])
}

enum VariantGroupRenderType {
  DROPDOWN
  BADGE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  SCHEDULED
  ARCHIVED
}

enum CampaignType {
  CROSS_SELLING
  UP_SELLING
}

enum CampaignOfferTargetPage {
  CHECKOUT_PAGE
  POST_CHECKOUT
  PRODUCT
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
  MERGED
}

enum LayoutComponentType {
  MARQUEE
  SLIDER
  PRODUCT_LIST
  CATEGORY_GRID
}

enum UserRole {
  OWNER
  ADMIN
  USER
}

enum Locale {
  TR
  EN
  DE
}

enum Currency {
  TRY
  USD
  EUR
  GBP
}

enum VariantGroupType {
  LIST
  COLOR
}

enum AssetType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum ProductType {
  DIGITAL
  PHYSICAL
}

enum CountryType {
  NONE
  STATE
  CITY
}

enum WhereAdded {
  PRODUCT_PAGE
  CATEGORY_PAGE
  BRAND_PAGE
  CART_PAGE
}

enum inVisibleCause {
  DELETED
  DELETED_BY_USER
  DELETED_BY_ADMIN
  OUT_OF_STOCK
  CURRENCY_MISMATCH
  LOCALE_MISMATCH
  PRODUCT_DELETED
  VARIANT_DELETED
  PRODUCT_DEACTIVATED
}

enum RuleType {
  SalesPrice
  ProductWeight
}

enum PaymentProvider {
  IYZICO
  PAYTR
  STRIPE
  PAYPAL
  BANK_TRANSFER
}

enum DiscountType {
  PERCENTAGE
  PERCENTAGE_GROW_QUANTITY
  PERCENTAGE_GROW_PRICE
  FIXED_AMOUNT
  FIXED_AMOUNT_GROW_QUANTITY
  FIXED_AMOUNT_GROW_PRICE
  FREE_SHIPPING
}

enum AllowedDiscountedItemsBy {
  price
  discounted_price
}

enum DiscountConditionType {
  PRODUCT
  CATEGORY
  BRAND
  VARIANT
}

enum DiscountEffectType {
  AUTOMATIC
  COUPON
}

enum DiscountWhereVisible {
  PRODUCT_PAGE
  CHECKOUT_PAGE
  ALL
}

enum CartActivityType {
  CART_CREATED
  CART_MERGED
  CART_STATUS_CHANGED
  ITEM_ADDED
  ITEM_REMOVED
  ITEM_QUANTITY_CHANGED
  ITEM_VISIBILITY_CHANGED
  SHIPPING_ADDRESS_SET
  BILLING_ADDRESS_SET
  PAYMENT_ATTEMPT_FAILED
  PAYMENT_ATTEMPT_SUCCESS
}

enum ActorType {
  USER
  ADMIN
  SYSTEM
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  PARTIALLY_SHIPPED
  SHIPPED
  PARTIALLY_DELIVERED
  DELIVERED
  CANCELLED
  PARTIALLY_REFUNDED
  REFUNDED
  COMPLETED
}

enum OrderItemStatus {
  PENDING
  PREPARING
  SHIPPED
  DELIVERED
  CANCEL_REQUESTED
  CANCEL_REJECTED
  CANCELLED
  REFUND_REQUESTED
  REFUND_REQUEST_ACCEPTED
  REFUND_REJECTED
  REFUNDED
}

enum PaymentStatus {
  FAILED
  PAID
  PARTIALLY_PAID
  PENDING
}

enum PaymentType {
  APP_PAYMENT
  BANK_REDIRECT
  BUY_ONLINE_PAY_AT_STORE
  CASH
  CASH_ON_DELIVERY
  CREDIT_CARD
  CREDIT_CARD_ON_DELIVERY
  DIRECT_DEBIT
  GIFT_CARD
  MONEY_ORDER
  OTHER
  PAY_LATER
  SLICE_IT
  WALLET
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum CardAssociation {
  VISA
  MASTER_CARD
  AMERICAN_EXPRESS
  TROY
  DISCOVER
  DINERS_CLUB
  JCB
  UNIONPAY
  MAESTRO
  MIR
  CUP
  UNKNOWN
}

enum PageType {
  HOME
  CATEGORY
  PRODUCT
  BRAND
  OTHER
}

view ProductListingView {
  productId               String
  variantId               String
  currency                Currency
  finalPrice              Float
  originalPrice           Float
  discountPercentage      Float
  brandId                 String?
  createdAt               DateTime
  stock                   Int
  visibleAllCombinations  Boolean
  sku                     String?
  categoryIds             String[]
  categorySlugs           String[]
  tagIds                  String[]
  tagSlugs                String[]
  variantOptionIds        String[]
  brandSlugs              String[]
  variantOptionSlugs      String[]
  variantGroupOptionSlugs String[]
  priceRank               Int

  @@unique([productId, variantId, currency])
  @@map("ProductListingView")
}

// =====================
// LOCATION YÖNETİMİ
// =====================

enum LocationType {
  WAREHOUSE // Ana depo
  STORE // Fiziksel mağaza
  SUPPLIER // Tedarikçi (dropship için)
  FULFILLMENT // 3PL fulfillment center
  VIRTUAL // Sanal stok (pre-order vs.)
}

model InventoryLocation {
  id                   String       @id @default(cuid())
  name                 String
  type                 LocationType
  isActive             Boolean      @default(true)
  isFulfillmentEnabled Boolean      @default(true) // Bu lokasyondan sipariş karşılanabilir mi?
  priority             Int          @default(0) // Stok düşme önceliği

  // Adres bilgileri (opsiyonel)
  addressLine1 String?
  addressLine2 String?
  zipCode      String?

  cityId     String?
  stateId    String?
  countryId  String?
  districtId String?

  country  Country?  @relation(fields: [countryId], references: [id])
  state    State?    @relation(fields: [stateId], references: [id])
  city     City?     @relation(fields: [cityId], references: [id])
  district District? @relation(fields: [districtId], references: [id])

  // ===== Koordinatlar (Override veya City'den al) =====
  // Eğer depo şehir merkezinde değilse manuel gir
  latitude  String?
  longitude String?

  // ===== Servis Bölgesi (Hangi bölgelere hizmet verir) =====
  serviceZones InventoryLocationServiceZone[]

  // İletişim
  contactName  String?
  contactEmail String?
  contactPhone String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  inventoryLevels InventoryLevel[]
  movements       InventoryMovement[]
  transfersFrom   InventoryTransfer[] @relation("TransferFrom")
  transfersTo     InventoryTransfer[] @relation("TransferTo")
  supplierOrders  SupplierOrder[]

  @@index([type, isActive])
  @@index([priority])
}

// =====================
// INVENTORY ITEM & LEVEL
// =====================

model InventoryItem {
  id        String  @id @default(cuid())
  variantId String  @unique
  sku       String? // Denormalized for quick access

  // Tracking settings
  tracked           Boolean @default(true) // Stok takibi yapılsın mı?
  allowNegative     Boolean @default(false) // Negatif stoka izin ver
  lowStockThreshold Int? // Düşük stok uyarı eşiği

  // Ağırlık/boyut (kargo hesaplaması için)
  weight     Float?
  weightUnit WeightUnit @default(KG)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variant   ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)
  levels    InventoryLevel[]
  movements InventoryMovement[]

  @@index([sku])
}

model InventoryLevel {
  id              String @id @default(cuid())
  inventoryItemId String
  locationId      String

  // Stok değerleri
  available Int @default(0) // Satışa açık
  reserved  Int @default(0) // Sepette/siparişte bekleyen
  committed Int @default(0) // Onaylanmış sipariş, henüz gönderilmedi
  incoming  Int @default(0) // Yolda olan (supplier'dan)
  damaged   Int @default(0) // Hasarlı

  // computed: onHand = available + reserved + committed
  // computed: sellable = available

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventoryItem InventoryItem     @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  location      InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([inventoryItemId, locationId])
  @@index([locationId])
  @@index([available])
}

// =====================
// STOK HAREKETLERİ
// =====================

enum MovementType {
  // Giriş
  PURCHASE // Satın alma
  RETURN // Müşteri iadesi
  TRANSFER_IN // Transfer girişi
  ADJUSTMENT_ADD // Manuel ekleme
  PRODUCTION // Üretim

  // Çıkış  
  SALE // Satış
  TRANSFER_OUT // Transfer çıkışı
  ADJUSTMENT_REMOVE // Manuel çıkarma
  DAMAGED // Hasar
  LOST // Kayıp
  EXPIRED // Son kullanma tarihi geçmiş

  // Rezervasyon
  RESERVE // Sepete ekleme
  UNRESERVE // Sepetten çıkarma
  COMMIT // Sipariş onayı
  UNCOMMIT // Sipariş iptali
  FULFILL // Gönderim
}

// Bir deponun hangi şehirlere/illere hizmet verdiği
model InventoryLocationServiceZone {
  id         String @id @default(cuid())
  locationId String

  // Ülke bilgisi
  countryId   String
  countryType CountryType // Ülkenin tipi (redundant ama query kolaylığı için)

  // Bölge tanımı - CountryType'a göre kullanılır
  // STATE tipli ülkeler için (ABD, Almanya vs)
  stateIds String[] @default([]) // Boş = tüm state'ler

  // CITY tipli ülkeler için (Türkiye, Fransa vs)
  cityIds String[] @default([]) // Boş = tüm şehirler

  // NONE tipli ülkeler için sadece countryId yeterli

  // Öncelik ve teslimat
  priority              Int  @default(0)
  estimatedDeliveryDays Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  country  Country           @relation(fields: [countryId], references: [id])

  @@unique([locationId, countryId]) // Bir lokasyon, bir ülke için tek zone
  @@index([countryId])
}

model InventoryMovement {
  id              String @id @default(cuid())
  inventoryItemId String
  locationId      String

  type     MovementType
  quantity Int // + veya - olabilir

  // Önceki ve sonraki değerler (audit için)
  previousAvailable Int
  newAvailable      Int
  previousReserved  Int?
  newReserved       Int?

  // Referanslar
  orderId         String?
  orderItemId     String?
  transferId      String?
  supplierOrderId String?
  adjustmentId    String?

  // Meta
  reason    String?
  note      String?
  actorType ActorType @default(SYSTEM)
  actorId   String?

  createdAt DateTime @default(now())

  inventoryItem InventoryItem        @relation(fields: [inventoryItemId], references: [id])
  location      InventoryLocation    @relation(fields: [locationId], references: [id])
  transfer      InventoryTransfer?   @relation(fields: [transferId], references: [id])
  adjustment    InventoryAdjustment? @relation(fields: [adjustmentId], references: [id])

  @@index([inventoryItemId, createdAt(sort: Desc)])
  @@index([locationId, createdAt(sort: Desc)])
  @@index([type, createdAt(sort: Desc)])
  @@index([orderId])
}

// =====================
// TRANSFER (Lokasyonlar arası)
// =====================

enum TransferStatus {
  DRAFT
  PENDING // Onay bekliyor
  IN_TRANSIT // Yolda
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model InventoryTransfer {
  id             String @id @default(cuid())
  transferNumber String @unique

  fromLocationId String
  toLocationId   String

  status TransferStatus @default(DRAFT)

  expectedDate DateTime?
  shippedAt    DateTime?
  receivedAt   DateTime?

  note String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromLocation InventoryLocation       @relation("TransferFrom", fields: [fromLocationId], references: [id])
  toLocation   InventoryLocation       @relation("TransferTo", fields: [toLocationId], references: [id])
  items        InventoryTransferItem[]
  movements    InventoryMovement[]

  @@index([status])
  @@index([fromLocationId])
  @@index([toLocationId])
}

model InventoryTransferItem {
  id         String @id @default(cuid())
  transferId String
  variantId  String

  quantityExpected Int
  quantityShipped  Int @default(0)
  quantityReceived Int @default(0)

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transfer InventoryTransfer         @relation(fields: [transferId], references: [id], onDelete: Cascade)
  variant  ProductVariantCombination @relation(fields: [variantId], references: [id])

  @@unique([transferId, variantId])
}

// =====================
// MANUEL DÜZELTME (Sayım vs.)
// =====================

enum AdjustmentReason {
  CYCLE_COUNT // Periyodik sayım
  STOCK_COUNT // Tam sayım
  SHRINKAGE // Fire
  DAMAGE // Hasar
  CORRECTION // Düzeltme
  RECOUNT // Yeniden sayım
  OTHER
}

model InventoryAdjustment {
  id               String           @id @default(cuid())
  adjustmentNumber String           @unique
  locationId       String
  reason           AdjustmentReason
  note             String?

  createdBy  String
  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     InventoryAdjustmentItem[]
  movements InventoryMovement[]

  @@index([locationId])
  @@index([reason])
}

model InventoryAdjustmentItem {
  id           String @id @default(cuid())
  adjustmentId String
  variantId    String

  previousQuantity Int
  newQuantity      Int
  difference       Int // computed: new - previous

  createdAt DateTime @default(now())

  adjustment InventoryAdjustment       @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  variant    ProductVariantCombination @relation(fields: [variantId], references: [id])

  @@unique([adjustmentId, variantId])
}

// =====================
// TEDARİKÇİ YÖNETİMİ
// =====================

model Supplier {
  id      String  @id @default(cuid())
  name    String
  code    String? @unique
  email   String?
  phone   String?
  website String?

  // Adres
  addressLine1 String?
  addressLine2 String?
  cityId       String?
  countryId    String?

  // Ödeme koşulları
  paymentTermsDays Int? // Ödeme vadesi (gün)
  currency         Currency @default(TRY)

  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  products SupplierProduct[]
  orders   SupplierOrder[]

  @@index([isActive])
}

model SupplierProduct {
  id         String @id @default(cuid())
  supplierId String
  variantId  String

  supplierSku      String? // Tedarikçinin SKU'su
  cost             Float? // Maliyet
  currency         Currency @default(TRY)
  leadTimeDays     Int? // Tedarik süresi
  minOrderQuantity Int? // Minimum sipariş adedi

  isPreferred Boolean @default(false) // Tercih edilen tedarikçi
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier Supplier                  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  variant  ProductVariantCombination @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([supplierId, variantId])
  @@index([variantId])
}

// =====================
// SATIN ALMA SİPARİŞİ
// =====================

enum SupplierOrderStatus {
  DRAFT
  SENT // Tedarikçiye gönderildi
  CONFIRMED // Tedarikçi onayladı
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model SupplierOrder {
  id            String @id @default(cuid())
  orderNumber   String @unique
  supplierId    String
  destinationId String // Hangi lokasyona gelecek

  status SupplierOrderStatus @default(DRAFT)

  currency     Currency @default(TRY)
  subtotal     Float    @default(0)
  taxAmount    Float    @default(0)
  shippingCost Float    @default(0)
  totalAmount  Float    @default(0)

  expectedDate DateTime?
  orderedAt    DateTime?
  receivedAt   DateTime?

  note String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  destination InventoryLocation   @relation(fields: [destinationId], references: [id])
  items       SupplierOrderItem[]

  @@index([supplierId])
  @@index([status])
  @@index([destinationId])
}

model SupplierOrderItem {
  id              String @id @default(cuid())
  supplierOrderId String
  variantId       String

  quantityOrdered  Int
  quantityReceived Int @default(0)

  unitCost  Float
  totalCost Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierOrder SupplierOrder             @relation(fields: [supplierOrderId], references: [id], onDelete: Cascade)
  variant       ProductVariantCombination @relation(fields: [variantId], references: [id])

  @@unique([supplierOrderId, variantId])
}

// =====================
// ENUMS
// =====================

enum WeightUnit {
  KG
  GR
  LB
  OZ
}

model FulfillmentStrategy {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Zod: FulfillmentStrategyType
  type String @default("PROXIMITY")

  // Yönetim Flagleri
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)
  priority  Int     @default(0)

  allowSplitShipment  Boolean @default(false)
  maxSplitCount       Int?
  allowBackorder      Boolean @default(false)
  allowDropship       Boolean @default(false)
  defaultLeadTimeDays Int     @default(0)
  processOnHolidays   Boolean @default(false)

  decisionTree Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decisions FulfillmentDecision[] // Loglar ile ilişki

  @@index([isActive, priority])
  @@index([isDefault])
}

model FulfillmentDecision {
  id      String @id @default(cuid())
  orderId String

  strategyId   String?
  decisionType FulfillmentDecisionType // FulfillmentDecisionType

  assignedLocationId String?
  supplierId         String?

  // Hangi kural match etti, neden bu karar
  matchedRuleId String?
  evaluationLog Json?

  createdAt DateTime @default(now())

  strategy FulfillmentStrategy? @relation(fields: [strategyId], references: [id])

  @@index([orderId])
  @@index([strategyId])
}

// =====================
// FULFILLMENT EXECUTION LOG
// =====================

enum FulfillmentDecisionType {
  AUTO_ASSIGNED // Otomatik atandı
  SPLIT_SHIPMENT // Bölündü
  DROPSHIP // Dropship'e yönlendirildi
  BACKORDER // Backorder'a alındı
  MANUAL_REQUIRED // Manuel müdahale gerekli
  REJECTED // Reddedildi
}

// ============================================
// LOGICAL OPERATORS (Gruplar için)
// ============================================

// Zaten FilterOperator var, onu rename edelim
enum LogicalOperator {
  AND
  OR
}
